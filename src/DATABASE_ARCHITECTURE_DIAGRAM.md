# ðŸ—ï¸ Estal Database Architecture: Understanding User Profiles

## ðŸ“Š Visual Explanation of the "user_id" Error

---

## âŒ PROBLEM: What Was Happening

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR APPLICATION                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User registers â†’ Saved to KV Store (kv_store_96250128)   â”‚
â”‚  Key: "user_profile:123e4567-..."                          â”‚
â”‚  Value: {"id": "123...", "name": "Ali", "role": "admin"}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â¬‡
                            
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  POSTGRES DATABASE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ properties   â”‚        â”‚ user_profilesâ”‚                   â”‚
â”‚  â”‚              â”‚   â•±â”€â†’  â”‚   âŒ MISSING!â”‚                   â”‚
â”‚  â”‚ id           â”‚  â•±     â”‚              â”‚                   â”‚
â”‚  â”‚ name         â”‚ â•±      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  â”‚ owner_id â”€â”€â”€â”€â•±                                           â”‚
â”‚  â”‚              â”‚   â† "Column user_id does not exist!"     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                              â”‚
â”‚  RLS Policies try to query user_profiles â†’ âŒ ERROR!        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why this fails:**
- âœ… Users ARE stored (in KV store)
- âŒ `user_profiles` table DOESN'T exist in Postgres
- âŒ Properties table references non-existent table
- âŒ RLS policies can't query user data
- âŒ Everything breaks! ðŸ’¥

---

## âœ… SOLUTION: How We Fix It

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR APPLICATION                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User registers â†’ Saved to KV Store (kv_store_96250128)   â”‚
â”‚  Key: "user_profile:123e4567-..."                          â”‚
â”‚  Value: {"id": "123...", "name": "Ali", "role": "admin"}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â¬‡
                            
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  POSTGRES DATABASE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ kv_store_96250128 (table)                     â”‚         â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚ â”‚ key                    â”‚ value           â”‚  â”‚         â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚
â”‚  â”‚ â”‚ user_profile:123...   â”‚ {"id":"123"...} â”‚  â”‚         â”‚
â”‚  â”‚ â”‚ user_profile:456...   â”‚ {"id":"456"...} â”‚  â”‚         â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                       â¬‡                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚            â”‚ user_profiles (VIEW)â”‚ â† âœ… We create this!     â”‚
â”‚            â”‚ â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”â”‚                          â”‚
â”‚            â”‚ â”‚ id â”‚ name â”‚ role â”‚â”‚                          â”‚
â”‚            â”‚ â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤â”‚                          â”‚
â”‚            â”‚ â”‚123 â”‚ Ali  â”‚adminâ”‚â”‚                          â”‚
â”‚            â”‚ â”‚456 â”‚Sara â”‚ownerâ”‚â”‚                          â”‚
â”‚            â”‚ â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”‚                          â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                       â¬†                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                                     â”‚
â”‚  â”‚ properties   â”‚     â”‚                                     â”‚
â”‚  â”‚              â”‚     â”‚                                     â”‚
â”‚  â”‚ id           â”‚     â”‚                                     â”‚
â”‚  â”‚ name         â”‚     â”‚                                     â”‚
â”‚  â”‚ owner_id â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜  âœ… Can query user_profiles!       â”‚
â”‚  â”‚              â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                              â”‚
â”‚  RLS Policies query user_profiles VIEW â†’ âœ… WORKS!          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why this works:**
- âœ… View makes KV store queryable as SQL table
- âœ… Properties can reference owner_id
- âœ… RLS policies can check user roles
- âœ… Dashboard KPIs can aggregate data
- âœ… Everything works! ðŸŽ‰

---

## ðŸ” Deep Dive: What is a VIEW?

### Traditional Table (What you might expect)
```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY,
  name TEXT,
  email TEXT,
  role TEXT
);

-- Data stored physically in this table
INSERT INTO user_profiles VALUES 
  ('123...', 'Ali', 'ali@example.com', 'admin');
```

### VIEW (What we actually use)
```sql
CREATE VIEW user_profiles AS
SELECT 
  (value->>'id')::uuid as id,
  value->>'name' as name,
  value->>'email' as email,
  value->>'role' as role
FROM kv_store_96250128
WHERE key LIKE 'user_profile:%';

-- No data stored here!
-- It's a "live query" that runs every time you SELECT
-- Data comes from kv_store_96250128
```

### Comparison

| Feature | Table | View |
|---------|-------|------|
| **Stores data** | âœ… Yes, physically | âŒ No, virtual |
| **Can SELECT** | âœ… Yes | âœ… Yes |
| **Can INSERT** | âœ… Yes | âŒ No (mostly) |
| **Performance** | âš¡ Fast | âš¡ Fast (if indexed) |
| **Storage** | Uses disk space | No extra space |
| **Updates** | Manual | Auto-reflects source |

---

## ðŸŽ¯ Data Flow: Registration to Query

### 1ï¸âƒ£ User Registers
```
Frontend                     Backend                    Database
   â”‚                           â”‚                           â”‚
   â”‚â”€â”€â”€ POST /register â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
   â”‚                           â”‚                           â”‚
   â”‚                           â”‚â”€â”€â”€ Save to KV store â”€â”€â”€â”€â”€â†’â”‚
   â”‚                           â”‚    Key: user_profile:123  â”‚
   â”‚                           â”‚    Value: {user data}     â”‚
   â”‚                           â”‚                           â”‚
   â”‚â†â”€â”€â”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â†â”€â”€â”€ Saved â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### 2ï¸âƒ£ App Queries User Info
```
Frontend                     Backend                    Database
   â”‚                           â”‚                           â”‚
   â”‚â”€â”€â”€ GET /properties â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
   â”‚                           â”‚                           â”‚
   â”‚                           â”‚â”€â”€â”€ SELECT * FROM properties
   â”‚                           â”‚     WHERE owner_id = ?    â”‚
   â”‚                           â”‚                           â”‚
   â”‚                           â”‚     (RLS policy checks)   â”‚
   â”‚                           â”‚     SELECT role FROM      â”‚
   â”‚                           â”‚     user_profiles â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                           â”‚                           â”‚
   â”‚                           â”‚     (VIEW queries KV)     â”‚
   â”‚                           â”‚â†â”€â”€â”€ Ali, admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                           â”‚                           â”‚
   â”‚â†â”€â”€â”€ Properties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â†â”€â”€â”€ [property data] â”€â”€â”€â”€â”€â”€â”‚
```

### 3ï¸âƒ£ Behind the Scenes: How VIEW Works
```sql
-- User queries:
SELECT * FROM user_profiles WHERE id = '123...';

-- Postgres actually executes:
SELECT 
  (value->>'id')::uuid as id,
  value->>'name' as name,
  value->>'email' as email,
  value->>'role' as role
FROM kv_store_96250128
WHERE key LIKE 'user_profile:%'
  AND (value->>'id')::uuid = '123...';

-- Result:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚  id  â”‚ name â”‚      email       â”‚ role  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 123  â”‚ Ali  â”‚ ali@example.com  â”‚ admin â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”§ Architecture Decisions: Why KV Store?

### â“ Why not use a regular `user_profiles` table?

**Original Design Decision:**
```
âœ… Pros of KV Store:
â€¢ Fast reads/writes
â€¢ Schema flexibility (JSON)
â€¢ Easy to add new fields
â€¢ Integrated with Supabase Auth
â€¢ Built-in caching
â€¢ No migrations needed

âŒ Cons of Regular Table:
â€¢ Rigid schema
â€¢ Requires migrations for changes
â€¢ More complex setup
â€¢ Duplicate auth data
```

### ðŸ¤” Why add a VIEW then?

**Best of Both Worlds:**
```
KV Store (source)     +     VIEW (interface)
      â†“                            â†“
Fast, flexible              SQL queries work
JSON storage                RLS policies work
Easy updates                Joins work
                            Dashboard KPIs work
```

---

## ðŸ“‹ Complete Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (React)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Dashboard  â”‚  â”‚ Properties   â”‚  â”‚ User Mgmt   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“ Supabase Client
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUPABASE BACKEND                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  EDGE FUNCTIONS                         â”‚   â”‚
â”‚  â”‚  /make-server/register â†’ Saves to KV store             â”‚   â”‚
â”‚  â”‚  /make-server/users â†’ Reads from user_profiles VIEW    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  POSTGRES DATABASE                      â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ kv_store_96250128 (Physical Table)            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Stores user profiles as JSON               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Key: "user_profile:{uuid}"                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Value: {"id", "name", "email", "role"...}  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                         â†“                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ user_profiles (VIEW)                          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Virtual table over KV store                â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Columns: id, name, email, role, status...  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ No physical storage                        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚            â†“              â†“              â†“              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ properties   â”‚  â”‚ maintenance_ â”‚  â”‚ financial_   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚ requests     â”‚  â”‚ reports      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ owner_id â”€â”€â”€â”€â”¤  â”‚              â”‚  â”‚              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  (references â”‚  â”‚              â”‚  â”‚              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚   user_      â”‚  â”‚              â”‚  â”‚              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚   profiles.  â”‚  â”‚              â”‚  â”‚              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚   id)        â”‚  â”‚              â”‚  â”‚              â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  All tables have RLS policies that query user_profiles â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  AUTHENTICATION                         â”‚   â”‚
â”‚  â”‚  â€¢ Supabase Auth manages login/logout                  â”‚   â”‚
â”‚  â”‚  â€¢ auth.uid() provides current user ID                 â”‚   â”‚
â”‚  â”‚  â€¢ RLS policies use auth.uid() for access control      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸŽ“ Understanding RLS with VIEWs

### Example: Admin checking properties

```sql
-- Policy:
CREATE POLICY "Admins can view all properties"
  ON properties FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- When admin queries properties:
SELECT * FROM properties;

-- Postgres executes:
1. Get current user ID: auth.uid() â†’ '123...'

2. Check policy - Query the VIEW:
   SELECT 1 FROM user_profiles
   WHERE id = '123...' AND role = 'admin'
   
3. VIEW expands to:
   SELECT 1 FROM (
     SELECT (value->>'id')::uuid as id,
            value->>'role' as role
     FROM kv_store_96250128
     WHERE key LIKE 'user_profile:%'
   ) AS user_profiles
   WHERE id = '123...' AND role = 'admin'
   
4. If match found â†’ Allow query
   If no match â†’ Deny query

-- Result: Only admins see properties!
```

---

## ðŸ’¡ Key Takeaways

1. **Users stored in KV store** (kv_store_96250128 table)
2. **VIEW makes them queryable** (user_profiles view)
3. **Other tables reference the view** (properties.owner_id)
4. **RLS policies query the view** (role checks)
5. **Everything works seamlessly** âœ¨

---

## ðŸ”— Related Documentation

- **Fix Guide**: [DATABASE_FIX_USER_ID_ERROR.md](DATABASE_FIX_USER_ID_ERROR.md)
- **Quick Fix**: [FIX_USER_ID_ERROR_NOW.md](FIX_USER_ID_ERROR_NOW.md)
- **SQL Comparison**: [SQL_FILE_COMPARISON.md](SQL_FILE_COMPARISON.md)
- **KV Store Guide**: [docs/KV_STORE_OPTIMIZATION_GUIDE.md](docs/KV_STORE_OPTIMIZATION_GUIDE.md)

---

**Last Updated:** October 30, 2025  
**Architecture:** Supabase + KV Store + PostgreSQL VIEWs  
**Pattern:** Virtual Tables for Flexible Data Storage
